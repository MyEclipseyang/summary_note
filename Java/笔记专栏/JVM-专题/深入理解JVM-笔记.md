## 深入理解JVM-笔记

### 1.JVM内存划分

Java虚拟机会把他管理的内存划分为若干个数据区域，而根据《Java虚拟机规范》无论怎么去实现JVM，在划分数据区域时都必须遵循以下规定

![image-20220324105245129](https://gitee.com/BossZyy/note_img/raw/master/data/image-20220324105245129.png)

- 程序计数器，线程私有，用来记录正在执行虚拟机字节码指令的地址，任何情况下都不会发生内存溢出
- 虚拟机栈，线程私有，用于存放栈帧，每个方法执行时都会创建一个栈帧，而栈帧用来存放局部变量表，操作数栈和出口信息等。当栈的深度大于虚拟机允许的深度会抛出StackOverFlowError。当虚拟机不支持栈动态扩展，而栈需要扩展申请内存时会抛出OutOfMemoryError
- 本地方法栈，为执行本地方法服务，也会抛出StackOverFlowError和OutOfMemoryError
- 堆，用来存储对象实例，《Java虚拟机规范》要求堆需要逻辑连续存储数据，当没有足够内存来存放新创建的对象时会抛出OutOfMemoryError
- 方法区，用来存放虚拟机加载的类型信息，常量，静态变量等信息，也会抛出OutOfMemoryError

### 2.the whole life of a object

#### 2.1创建

> 以下讨论创建对象仅限于普通Java对象，不包括数组和Class对象

- 去常量池中定位类符号引用
- 检查符号引用代表的类是否加载、解析和初始化过，没有则进行类加载等过程
- 为对象实例在堆中分配内存（如何分配取决于用的垃圾回收器的回收算法）
- 对象初始化零值
- 对象头数据初始化（哪个类的实例、GC年龄、锁标志等)
- 执行\<init>()方法

在HotSpot虚拟机里，一个对象内存布局可划分为对象头、实例数据和对齐填充。对象头在32位和64位系统中分别占32比特和64比特，在32位系统中，25个比特用来存对象的hash值，4个比特存分代年龄，2个比特存锁标志，1个比特固定位0。因为HotSpot虚拟机的内存管理系统要求对象的起始终止地址必须为8的倍数，所以对齐填充部分用来给地址凑整。

![image-20220324140506914](https://gitee.com/BossZyy/note_img/raw/master/data/image-20220324140506914.png)

#### 2.2访问

HotSpot采用直接指针来访问堆中的对象，优点是访问速度快，缺点是垃圾回收时需要改动栈中的对象引用

![image-20220324141006132](https://gitee.com/BossZyy/note_img/raw/master/data/image-20220324141006132.png)

#### 2.3死亡